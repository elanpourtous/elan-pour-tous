<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contact — Version corrigée et accessible</title>
  <meta name="description" content="Formulaire de contact conforme accessibilité, responsive et validé côté client." />
  <style>
    :root {
      --gap: 1rem;
      --radius: 14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    html { box-sizing: border-box; font-family: var(--font); }
    *, *::before, *::after { box-sizing: inherit; }
    body { margin: 0; padding: 0; line-height: 1.5; background: #f7f7fb; }

    header { padding: 2rem 1rem 0; text-align: center; }
    header h1 { margin: 0; font-size: clamp(1.4rem, 2vw + 1rem, 2.2rem); }
    header p { margin: .25rem 0 2rem; color: #333; }

    main { display: grid; place-items: start center; padding: 0 1rem 3rem; }

    form {
      width: min(900px, 100%);
      background: #fff;
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }

    .grid { display: grid; gap: var(--gap); }
    @media (min-width: 680px) {
      .grid-2 { grid-template-columns: 1fr 1fr; }
    }

    label { display: inline-block; font-weight: 600; margin-bottom: .25rem; }
    .required::after { content: " *"; color: #b00020; }

    input[type="text"], input[type="email"], input[type="tel"], select, textarea {
      width: 100%; padding: .75rem .85rem; border: 1px solid #d7d7df; border-radius: 10px;
      background: #fff; font-size: 1rem; outline: none;
    }
    textarea { min-height: 140px; resize: vertical; }

    input:focus, select:focus, textarea:focus { border-color: #5a67d8; box-shadow: 0 0 0 3px rgba(90,103,216,.2); }
    [aria-invalid="true"] { border-color: #b00020; box-shadow: 0 0 0 3px rgba(176,0,32,.15); }

    .field { position: relative; }
    .hint { font-size: .9rem; color: #555; margin-top: .25rem; }

    .error { font-size: .9rem; color: #b00020; margin-top: .25rem; display: none; }
    .error[aria-hidden="false"] { display: block; }

    .actions { display: flex; gap: .75rem; align-items: center; justify-content: flex-start; margin-top: .5rem; }
    button[type="submit"] {
      border: none; border-radius: 999px; padding: .9rem 1.1rem; font-weight: 700; cursor: pointer;
      background: #5a67d8; color: #fff; transition: transform .04s ease, box-shadow .2s;
      box-shadow: 0 8px 16px rgba(90,103,216,.25);
    }
    button[type="submit"]:active { transform: translateY(1px); box-shadow: 0 2px 6px rgba(0,0,0,.2); }

    .consent { display: grid; grid-template-columns: auto 1fr; gap: .6rem; align-items: start; }
    .visually-hidden {
      position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0);
      white-space: nowrap; border: 0;
    }

    .summary {
      border: 1px solid #f2c4c4; background: #fff8f8; color: #7a0015; padding: .75rem; border-radius: 10px; margin-bottom: 1rem;
      display: none;
    }
    .summary[aria-hidden="false"] { display: block; }
  </style>
</head>
<body>
  <a class="visually-hidden" href="#contact">Aller au contenu</a>

  <header>
    <h1>Contact</h1>
    <p>Une version soignée, accessible et prête à intégrer.</p>
  </header>

  <main>
    <form id="contact" aria-describedby="form-hint" novalidate>
      <p id="form-hint" class="hint">Les champs marqués d’un astérisque (*) sont obligatoires.</p>

      <div id="error-summary" class="summary" role="alert" aria-live="assertive" aria-hidden="true"></div>

      <div class="grid grid-2">
        <div class="field">
          <label for="firstname" class="required">Prénom</label>
          <input id="firstname" name="firstname" type="text" autocomplete="given-name" required />
          <p id="err-firstname" class="error" aria-hidden="true">Merci d’indiquer votre prénom.</p>
        </div>

        <div class="field">
          <label for="lastname" class="required">Nom</label>
          <input id="lastname" name="lastname" type="text" autocomplete="family-name" required />
          <p id="err-lastname" class="error" aria-hidden="true">Merci d’indiquer votre nom.</p>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="field">
          <label for="email" class="required">Email</label>
          <input id="email" name="email" type="email" autocomplete="email" inputmode="email" required />
          <p id="err-email" class="error" aria-hidden="true">Renseignez une adresse email valide.</p>
        </div>
        <div class="field">
          <label for="phone">Téléphone (optionnel)</label>
          <input id="phone" name="phone" type="tel" autocomplete="tel" inputmode="tel" pattern="^\+?[0-9 .-]{7,}$" />
          <p class="hint">Format libre : 06 12 34 56 78, +33 6 12 34 56 78…</p>
          <p id="err-phone" class="error" aria-hidden="true">Numéro invalide.</p>
        </div>
      </div>

      <div class="field">
        <label for="subject" class="required">Sujet</label>
        <select id="subject" name="subject" required>
          <option value="" selected>— Sélectionnez —</option>
          <option>Demande d’information</option>
          <option>Support</option>
          <option>Devis</option>
          <option>Autre</option>
        </select>
        <p id="err-subject" class="error" aria-hidden="true">Choisissez un sujet.</p>
      </div>

      <div class="field">
        <label for="message" class="required">Message</label>
        <textarea id="message" name="message" required maxlength="2000" aria-describedby="message-hint"></textarea>
        <p id="message-hint" class="hint">2000 caractères max.</p>
        <p id="err-message" class="error" aria-hidden="true">Votre message est requis.</p>
      </div>

      <!-- Consentement RGPD -->
      <div class="field">
        <div class="consent">
          <input id="consent" name="consent" type="checkbox" required />
          <label for="consent" class="required">J’autorise le traitement de mes données pour répondre à ma demande.</label>
        </div>
        <p id="err-consent" class="error" aria-hidden="true">Cochez cette case pour continuer.</p>
      </div>

      <!-- Anti-spam simple (honeypot) -->
      <div class="visually-hidden" aria-hidden="true">
        <label for="company">Société</label>
        <input id="company" name="company" type="text" tabindex="-1" autocomplete="off" />
      </div>

      <div class="actions">
        <button type="submit">Envoyer</button>
        <span aria-live="polite" id="status" class="hint"></span>
      </div>
    </form>
  </main>

  <script>
    (function () {
      const form = document.getElementById('contact');
      const summary = document.getElementById('error-summary');
      const status = document.getElementById('status');
      const fields = [
        { id: 'firstname', message: 'Merci d\'indiquer votre prénom.' },
        { id: 'lastname',  message: 'Merci d\'indiquer votre nom.' },
        { id: 'email',     message: 'Renseignez une adresse email valide.' },
        { id: 'subject',   message: 'Choisissez un sujet.' },
        { id: 'message',   message: 'Votre message est requis.' },
        { id: 'consent',   message: 'Cochez la case de consentement.' }
      ];

      function showError(input, msg) {
        input.setAttribute('aria-invalid', 'true');
        const err = document.getElementById('err-' + input.id) || null;
        if (err) { err.textContent = msg; err.setAttribute('aria-hidden', 'false'); }
      }
      function clearError(input) {
        input.removeAttribute('aria-invalid');
        const err = document.getElementById('err-' + input.id) || null;
        if (err) { err.setAttribute('aria-hidden', 'true'); }
      }

      function validateField(input) {
        // Select elements return "" when unselected
        if (input.type === 'checkbox') {
          if (!input.checked) { showError(input, 'Cochez cette case pour continuer.'); return false; }
          clearError(input); return true;
        }
        if (input.id === 'subject') {
          if (!input.value) { showError(input, 'Choisissez un sujet.'); return false; }
          clearError(input); return true;
        }
        if (input.validity.valid) { clearError(input); return true; }
        showError(input, input.validationMessage || 'Champ invalide.');
        return false;
      }

      fields.forEach(({ id }) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', () => validateField(el));
        el.addEventListener('blur', () => validateField(el));
        if (el.tagName === 'SELECT') { el.addEventListener('change', () => validateField(el)); }
      });

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        status.textContent = '';
        summary.setAttribute('aria-hidden', 'true');
        summary.textContent = '';

        // Honeypot: if filled, silently succeed to avoid hinting bots
        if (document.getElementById('company').value) {
          status.textContent = 'Merci, votre message a été envoyé.';
          form.reset();
          return;
        }

        let ok = true; let firstInvalid = null; const problems = [];
        for (const { id, message } of fields) {
          const el = document.getElementById(id);
          const valid = validateField(el);
          if (!valid) { ok = false; if (!firstInvalid) firstInvalid = el; problems.push(message); }
        }

        if (!ok) {
          summary.innerHTML = '<strong>Veuillez corriger les éléments suivants :</strong><ul>' + problems.map(p => `<li>${p}</li>`).join('') + '</ul>';
          summary.setAttribute('aria-hidden', 'false');
          if (firstInvalid) firstInvalid.focus();
          return;
        }        // Envoi AJAX réel (remplacez l'URL par celle de votre API)
        const payload = {
          firstname: document.getElementById('firstname').value.trim(),
          lastname:  document.getElementById('lastname').value.trim(),
          email:     document.getElementById('email').value.trim(),
          phone:     document.getElementById('phone').value.trim(),
          subject:   document.getElementById('subject').value,
          message:   document.getElementById('message').value.trim(),
          company:   document.getElementById('company').value // honeypot
        };

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.setAttribute('aria-busy', 'true');
        status.textContent = 'Envoi en cours…';

        fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(async (res) => {
          const data = await res.json().catch(() => ({}));
          if (!res.ok) { throw new Error(data.error || 'Échec de l\'envoi.'); }
          status.textContent = data.message || 'Merci, votre message a été envoyé.';
          form.reset();
        })
        .catch((err) => {
          status.textContent = err.message || 'Une erreur est survenue.';
        })
        .finally(() => {
          submitBtn.disabled = false;
          submitBtn.removeAttribute('aria-busy');
        });
      });
    })();
  </script>
</body>
</html>
