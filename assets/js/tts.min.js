(function(){if(window._ttsInit)return;window._ttsInit=true;const LS="ttsPrefs",hasTTS="speechSynthesis"in window&&"SpeechSynthesisUtterance"in window,play=document.getElementById("tts-play"),pause=document.getElementById("tts-pause"),resume=document.getElementById("tts-resume"),stopBtn=document.getElementById("tts-stop"),rate=document.getElementById("tts-rate"),rateVal=document.getElementById("tts-rate-val"),voiceSel=document.getElementById("tts-voice"),live=document.getElementById("tts-live"),bar=document.querySelector(".tts-bar");let queue=[],idx=0,locking=false,raf=null,pgPaused=false,pgStart=0,pgElapsed=0,pgDur=0,pgEl=null;function setState(p){[pause,resume,stopBtn].forEach(b=>b&&(b.disabled=!p));play&&(play.disabled=p)}function say(m){live&&(live.textContent=m)}function restore(){try{const p=JSON.parse(localStorage.getItem(LS)||"{}");p.rate&&rate&&(rate.value=String(p.rate),rateVal&&(rateVal.textContent=`${parseFloat(p.rate).toFixed(1)}Ã—`));p.voice&&voiceSel&&(voiceSel.value=p.voice)}catch{}}function save(){try{const p={rate:rate?parseFloat(rate.value||"1"):1,voice:voiceSel?voiceSel.value:""};localStorage.setItem(LS,JSON.stringify(p))}catch{}}function root(){return document.getElementById("contenu")||document.body}function blocks(){const m=root(),sel="h1,h2,h3,h4,h5,h6,p,li,blockquote,figcaption";return Array.from(m.querySelectorAll(sel)).filter(n=>(n.innerText||"").trim().length>0&&!n.closest(".tts-bar")).map(el=>({el,text:el.innerText.replace(/\s+/g," ").trim()}))}function selText(){return window.getSelection&&window.getSelection().toString().trim()||""}function selBlock(){const s=window.getSelection();if(!s||0===s.rangeCount)return null;let n=s.getRangeAt(0).commonAncestorContainer;1!==n.nodeType&&(n=n.parentNode);for(;n&&n!==document&&!/^(P|LI|BLOCKQUOTE|FIGCAPTION|H1|H2|H3|H4|H5|H6)$/.test(n.tagName);)n=n.parentNode;return n&&n.tagName?n:root()}function highlight(el){clearHL(),el&&el.classList&&(el.classList.add("tts-current"),(()=>{try{el.scrollIntoView({behavior:"smooth",block:"center"})}catch{}})())}function clearHL(){document.querySelectorAll(".tts-current").forEach(n=>n.classList.remove("tts-current"))}function voices(){if(!voiceSel)return;const v=speechSynthesis.getVoices();voiceSel.innerHTML="",v.filter(v=>v.lang.toLowerCase().startsWith("fr")).concat(v).filter((v,i,a)=>a.indexOf(v)===i).forEach(v=>{const o=document.createElement("option");o.value=v.name,o.textContent=`${v.name} (${v.lang})`,voiceSel.appendChild(o)}),restore()}function estDur(t){const w=(t||"").trim().split(/\s+/).filter(Boolean).length,base=3,rv=parseFloat(rate?.value||"1"),wps=Math.max(1.2,base*rv);return Math.max(1.5,w/wps)}function pgStartFn(el,txt){pgStopFn(),pgEl=el,pgEl&&pgEl.style.setProperty("--tts-progress","0%"),pgDur=1e3*estDur(txt),pgStart=performance.now(),pgPaused=false;const tick=n=>{if(!pgEl)return;const t=Math.min(1,(pgElapsed+(n-pgStart))/pgDur);pgEl.style.setProperty("--tts-progress",(100*t).toFixed(2)+"%"),t<1&&(raf=requestAnimationFrame(tick))};raf=requestAnimationFrame(tick)}function pgPauseFn(){if(pgPaused||!pgEl)return;pgPaused=true,pgElapsed+=performance.now()-pgStart,raf&&cancelAnimationFrame(raf),raf=null}function pgResumeFn(){if(!pgPaused||!pgEl)return;pgPaused=false,pgStart=performance.now();const n=>{if(!pgEl)return;const t=Math.min(1,(pgElapsed+(n-pgStart))/pgDur);pgEl.style.setProperty("--tts-progress",(100*t).toFixed(2)+"%"),t<1&&(raf=requestAnimationFrame(arguments.callee))};raf=requestAnimationFrame(function t(n){if(!pgEl)return;const e=Math.min(1,(pgElapsed+(n-pgStart))/pgDur);pgEl.style.setProperty("--tts-progress",(100*e).toFixed(2)+"%"),e<1&&(raf=requestAnimationFrame(t))})}function pgStopFn(){raf&&cancelAnimationFrame(raf),raf=null,pgStart=0,pgElapsed=0,pgDur=0,pgPaused=false,pgEl&&pgEl.style.removeProperty("--tts-progress"),pgEl=null}function speakQueue(startAt=0){if(locking)return;locking=true,idx=startAt;const next=()=>{if(idx>=queue.length)return setState(!1),say("Lecture terminÃ©e."),pgStopFn(),clearHL(),void(locking=!1);const it=queue[idx++],u=new SpeechSynthesisUtterance(it.text||"");u.lang="fr-FR",u.rate=parseFloat(rate?.value||"1");const ch=Array.from(speechSynthesis.getVoices()).find(v=>v.name===voiceSel?.value);ch&&(u.voice=ch),u.onstart=()=>{highlight(it.el),pgStartFn(it.el,it.text),say("Lecture en coursâ€¦"),setState(!0),save()},u.onend=()=>{pgStopFn(),clearHL(),setTimeout(next,0)},u.onerror=()=>{pgStopFn(),clearHL(),setTimeout(next,0)},speechSynthesis.speak(u)};next()}function onPlay(){const t=selText();if(t){const e=selBlock();return queue=[{el:e,text:t}],void speakQueue(0)}if(queue=blocks(),0===queue.length){const t=root().innerText.replace(/\s+/g," ").trim();queue=[{el:root(),text:t}]}speakQueue(0)}function onPause(){speechSynthesis.pause(),pgPauseFn(),say("Pause.")}function onResume(){speechSynthesis.resume(),pgResumeFn(),say("Reprise.")}function onStop(){speechSynthesis.cancel(),setState(!1),say("Lecture stoppÃ©e."),pgStopFn(),clearHL(),locking=!1}if(!hasTTS)return void(d&&d.insertAdjacentHTML("beforeend",'<span class="hint">ðŸ”‡ La lecture vocale nâ€™est pas disponible sur ce navigateur.</span>'),[play,pause,resume,stopBtn,rate,voiceSel].forEach(e=>e&&(e.disabled=!0)));voices(),void 0!==speechSynthesis.onvoiceschanged&&(speechSynthesis.onvoiceschanged=voices),play?.addEventListener("click",onPlay),pause?.addEventListener("click",onPause),resume?.addEventListener("click",onResume),stopBtn?.addEventListener("click",onStop),rate?.addEventListener("input",()=>{rateVal&&(rateVal.textContent=`${parseFloat(rate.value).toFixed(1)}Ã—`),save()}),voiceSel?.addEventListener("change",save),document.addEventListener("keydown",(e=>{if(!e.altKey)return;const t=e.key.toLowerCase();"l"===t&&(e.preventDefault(),onPlay()),"p"===t&&(e.preventDefault(),onPause()),"r"===t&&(e.preventDefault(),onResume()),"s"===t&&(e.preventDefault(),onStop())})),bar&&(bar.setAttribute("role","region"),bar.setAttribute("aria-label","Lecture Ã  voix haute"))})();
