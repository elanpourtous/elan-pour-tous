(function(){if(window._ttsInit)return;window._ttsInit=true;const LS='ttsPrefs',hasTTS='speechSynthesis'in window&&'SpeechSynthesisUtterance'in window,play=document.getElementById('tts-play'),pb=document.getElementById('tts-pause'),rb=document.getElementById('tts-resume'),sb=document.getElementById('tts-stop'),rt=document.getElementById('tts-rate'),rv=document.getElementById('tts-rate-val'),vs=document.getElementById('tts-voice'),lv=document.getElementById('tts-live'),bar=document.querySelector('.tts-bar');let Q=[],IDX=0,LOCK=false,RAF=null,PP=false,PS=0,ELAP=0,DUR=0,PEL=null;function S(x){[pb,rb,sb].forEach(b=>b&&(b.disabled=!x));play&&(play.disabled=x)}function SAY(t){lv&&(lv.textContent=t||'')}function REST(){try{const p=JSON.parse(localStorage.getItem(LS)||'{}');if(p.rate&&rt){rt.value=String(p.rate);rv&&(rv.textContent=`${parseFloat(p.rate).toFixed(1)}Ã—`)}if(p.voice&&vs)vs.value=p.voice}catch{}}function SAVE(){try{const p={rate:rt?parseFloat(rt.value||'1'):1,voice:vs?vs.value:''};localStorage.setItem(LS,JSON.stringify(p))}catch{}}function ROOT(){return document.getElementById('contenu')||document.body}function BLOCKS(){const m=ROOT(),sel='h1,h2,h3,h4,h5,h6,p,li,blockquote,figcaption';return Array.from(m.querySelectorAll(sel)).filter(n=>(n.innerText||'').trim().length>0&&!n.closest('.tts-bar')).map(el=>({el,text:el.innerText.replace(/\s+/g,' ').trim()}))}function SELTEXT(){return window.getSelection&&window.getSelection().toString().trim()||''}function SELBLOCK(){const s=window.getSelection();if(!s||0===s.rangeCount)return null;let n=s.getRangeAt(0).commonAncestorContainer;1!==n.nodeType&&(n=n.parentNode);for(;n&&n!==document&&!/^(P|LI|BLOCKQUOTE|FIGCAPTION|H1|H2|H3|H4|H5|H6)$/.test(n.tagName);)n=n.parentNode;return n&&n.tagName?n:ROOT()}function HL(el){CLR();el&&el.classList&&(el.classList.add('tts-current'),(()=>{try{el.scrollIntoView({behavior:'smooth',block:'center'})}catch{}})())}function CLR(){document.querySelectorAll('.tts-current').forEach(n=>n.classList.remove('tts-current'))}function estDur(t){const w=(t||'').trim().split(/\s+/).filter(Boolean).length,base=3,rvv=parseFloat(rt?.value||'1'),wps=Math.max(1.2,base*rvv);return Math.max(1.5,w/wps)}function progStart(el,txt){progStop();PEL=el,PEL&&PEL.style.setProperty('--tts-progress','0%'),DUR=1e3*estDur(txt),PS=performance.now(),PP=!1;const tick=n=>{if(!PEL)return;const t=Math.min(1,(ELAP+(n-PS))/DUR);PEL.style.setProperty('--tts-progress',(100*t).toFixed(2)+'%'),t<1?RAF=requestAnimationFrame(tick):0};RAF=requestAnimationFrame(tick)}function progPause(){if(PP||!PEL)return;PP=!0,ELAP+=performance.now()-PS,RAF&&cancelAnimationFrame(RAF),RAF=null}function progResume(){if(!PP||!PEL)return;PP=!1,PS=performance.now();const t=n=>{if(!PEL)return;const e=Math.min(1,(ELAP+(n-PS))/DUR);PEL.style.setProperty('--tts-progress',(100*e).toFixed(2)+'%'),e<1?RAF=requestAnimationFrame(t):0};RAF=requestAnimationFrame(t)}function progStop(){RAF&&cancelAnimationFrame(RAF),RAF=null,PS=0,ELAP=0,DUR=0,PP=!1,PEL&&PEL.style.removeProperty('--tts-progress'),PEL=null}function voices(){if(!vs)return;const a=speechSynthesis.getVoices();vs.innerHTML='',a.filter(v=>/^fr|^mg/i.test(v.lang)).concat(a).filter((v,i,arr)=>arr.indexOf(v)===i).forEach(v=>{const o=document.createElement('option');o.value=v.name,o.textContent=`${v.name} (${v.lang})`,vs.appendChild(o)}),REST()}function utter(text){const u=new SpeechSynthesisUtterance(text||'Aucun contenu Ã  lire.'),list=speechSynthesis.getVoices(),chosen=list.find(v=>v.name===(vs?.value||''));if(chosen)u.voice=chosen,u.lang=chosen.lang||'fr-FR';else u.lang='fr-FR';u.rate=parseFloat(rt?.value||'1');return u}function speakQueue(startAt){if(LOCK)return;LOCK=!0,IDX=startAt||0;const next=()=>{if(IDX>=Q.length)return S(!1),SAY('Lecture terminÃ©e.'),progStop(),CLR(),void(LOCK=!1);const it=Q[IDX++],u=utter(it.text);u.onstart=()=>{HL(it.el),progStart(it.el,it.text),SAY('Lecture en coursâ€¦'),S(!0),SAVE()},u.onend =()=>{progStop(),CLR(),setTimeout(next,0)},u.onerror=()=>{progStop(),CLR(),setTimeout(next,0)},speechSynthesis.speak(u)};next()}function onPlay(){const sel=SELTEXT();if(sel){const el=SELBLOCK();return Q=[{el,text:sel}],void speakQueue(0)}Q=BLOCKS(),0===Q.length&&(Q=[{el:ROOT(),text:ROOT().innerText.replace(/\s+/g,' ').trim()}]),speakQueue(0)}function onPause(){speechSynthesis.pause(),progPause(),SAY('Pause.')}function onResume(){speechSynthesis.resume(),progResume(),SAY('Reprise.')}function onStop(){speechSynthesis.cancel(),S(!1),SAY('Lecture stoppÃ©e.'),progStop(),CLR(),LOCK=!1}if(!hasTTS){return void(bar&&bar.insertAdjacentHTML('beforeend','<span class="hint">ðŸ”‡ La lecture vocale nâ€™est pas disponible sur ce navigateur.</span>'))}[play,pb,rb,sb,rt,vs].forEach(x=>x&&x.removeAttribute&&x.removeAttribute('disabled')),voices(),void 0!==speechSynthesis.onvoiceschanged&&(speechSynthesis.onvoiceschanged=voices),play&&play.addEventListener('click',onPlay),pb&&pb.addEventListener('click',onPause),rb&&rb.addEventListener('click',onResume),sb&&sb.addEventListener('click',onStop),rt&&rt.addEventListener('input',function(){rv&&(rv.textContent=`${parseFloat(rt.value).toFixed(1)}Ã—`),SAVE()}),vs&&vs.addEventListener('change',SAVE),document.addEventListener('keydown',function(e){if(!e.altKey)return;const k=e.key.toLowerCase();'l'===k&&(e.preventDefault(),onPlay()),'p'===k&&(e.preventDefault(),onPause()),'r'===k&&(e.preventDefault(),onResume()),'s'===k&&(e.preventDefault(),onStop())}),bar&&(bar.setAttribute('role','region'),bar.setAttribute('aria-label','Lecture Ã  voix haute'))})();
